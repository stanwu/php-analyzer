#!/usr/bin/env bash
# Pre-commit security hook
# Runs credential scan + flake8 lint on staged files before every commit.
# Install once with: make install-hooks

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
RESET='\033[0m'

pass() { echo -e "${GREEN}  ✓${RESET} $1"; }
fail() { echo -e "${RED}  ✗${RESET} $1"; }
info() { echo -e "${YELLOW}  →${RESET} $1"; }

echo -e "\n${BOLD}[pre-commit] Security checks${RESET}"

# ── Collect staged files ───────────────────────────────────────────────────────
STAGED_ALL=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)
STAGED_PY=$(echo "$STAGED_ALL"  | grep -E '\.py$'         || true)
STAGED_SEC=$(echo "$STAGED_ALL" | grep -E '\.(py|php|env)$' || true)

ERRORS=0

# ── 1. Credential scan ────────────────────────────────────────────────────────
if [ -n "$STAGED_SEC" ]; then
    info "Scanning staged files for credentials..."

    python3 - "$STAGED_SEC" <<'PYEOF'
import sys, re, subprocess

# Patterns that indicate real secrets (not test fixtures / placeholders)
PATTERNS = [
    (r'sk_live_[a-zA-Z0-9]{20,}',                         'Stripe live secret key'),
    (r'rk_live_[a-zA-Z0-9]{20,}',                         'Stripe live restricted key'),
    (r'AKIA[0-9A-Z]{16}',                                  'AWS Access Key ID'),
    (r'(?i)aws.{0,20}secret.{0,20}["\'][0-9a-zA-Z/+]{40}["\']', 'AWS Secret Access Key'),
    (r'ghp_[a-zA-Z0-9]{36}',                               'GitHub Personal Access Token'),
    (r'ghs_[a-zA-Z0-9]{36}',                               'GitHub Actions Secret'),
    (r'-----BEGIN (RSA|EC|DSA|OPENSSH) PRIVATE KEY-----',  'Private key'),
    (r'(?i)password\s*=\s*["\'][^"\']{8,}["\']',           'Hardcoded password'),
    (r'(?i)(api_key|apikey|api_secret)\s*=\s*["\'][^"\']{12,}["\']', 'Hardcoded API key'),
]

# Allow-list: patterns that are clearly test fixtures / placeholders
ALLOWLIST = re.compile(
    r'FAKE|PLACEHOLDER|EXAMPLE|YOUR_|<.*>|xxx+|000000|test_fixture|'
    r'sk_test_FAKE|REPLACE_ME|DUMMY',
    re.IGNORECASE,
)

staged_files = sys.argv[1].split('\n') if sys.argv[1] else []
found = []

for path in staged_files:
    path = path.strip()
    if not path:
        continue
    try:
        # Read the staged content (not working tree)
        content = subprocess.check_output(
            ['git', 'show', f':{path}'], stderr=subprocess.DEVNULL
        ).decode('utf-8', errors='replace')
    except subprocess.CalledProcessError:
        continue

    for lineno, line in enumerate(content.splitlines(), 1):
        if ALLOWLIST.search(line):
            continue
        for pattern, label in PATTERNS:
            if re.search(pattern, line):
                found.append((path, lineno, label, line.strip()[:80]))
                break  # one report per line

if found:
    print('\033[0;31m  ✗ Credential leak detected in staged files:\033[0m')
    for path, lineno, label, snippet in found:
        print(f'    {path}:{lineno}  [{label}]')
        print(f'      {snippet}')
    sys.exit(1)
else:
    print('\033[0;32m  ✓ No credentials detected\033[0m')
PYEOF

    if [ $? -ne 0 ]; then
        ERRORS=$((ERRORS + 1))
    fi
else
    pass "No .py/.php/.env files staged — skipping credential scan"
fi

# ── 2. Flake8 lint (staged .py files only) ────────────────────────────────────
if [ -n "$STAGED_PY" ]; then
    info "Running flake8 on staged Python files..."

    # Write staged content to temp files so flake8 can read them
    TMPDIR_HOOK=$(mktemp -d)
    trap 'rm -rf "$TMPDIR_HOOK"' EXIT

    LINT_FILES=()
    while IFS= read -r f; do
        [ -z "$f" ] && continue
        dest="$TMPDIR_HOOK/$f"
        mkdir -p "$(dirname "$dest")"
        git show ":$f" > "$dest" 2>/dev/null || continue
        LINT_FILES+=("$dest")
    done <<< "$STAGED_PY"

    if [ ${#LINT_FILES[@]} -gt 0 ]; then
        if ! python3 -m flake8 --version >/dev/null 2>&1; then
            echo -e "${YELLOW}  →${RESET} flake8 not installed — skipping lint (run: pip install flake8)"
        elif python3 -m flake8 \
            --max-line-length=100 \
            --extend-ignore=E501,W503 \
            "${LINT_FILES[@]}" 2>&1 | \
            sed "s|$TMPDIR_HOOK/||g"; then
            pass "flake8 passed"
        else
            fail "flake8 found issues — fix before committing"
            ERRORS=$((ERRORS + 1))
        fi
    fi
else
    pass "No .py files staged — skipping flake8"
fi

# ── Result ────────────────────────────────────────────────────────────────────
echo ""
if [ "$ERRORS" -gt 0 ]; then
    echo -e "${RED}${BOLD}[pre-commit] BLOCKED — $ERRORS check(s) failed${RESET}\n"
    exit 1
else
    echo -e "${GREEN}${BOLD}[pre-commit] All checks passed${RESET}\n"
    exit 0
fi
